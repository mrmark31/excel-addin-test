<!DOCTYPE html>
<html>
<head>
    <title>Excel Web Add-in</title>
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js" type="text/javascript"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            max-width: 800px; 
            margin: 0 auto;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .hidden {
            display: none;
        }
        input, select, button {
            margin: 10px 0;
            padding: 8px 12px;
            width: 200px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background: #0078d4;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #106ebe;
        }
        .success { 
            color: #107c10; 
            background: #dff6dd;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .error { 
            color: #d13438; 
            background: #fde7e9;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Form -->
        <div id="loginForm">
            <h2>Login</h2>
            <input type="text" id="username" placeholder="Username" /><br/>
            <input type="password" id="password" placeholder="Password" /><br/>
            <button onclick="login()">Sign In</button>
            <button onclick="resetForm()">Reset</button>
        </div>

        <!-- Main Form -->
        <div id="mainForm" class="hidden">
            <h2>Report Configuration</h2>
            <select id="reportType" onchange="handleReportTypeChange()">
                <option value="">Select Report Type</option>
                <option value="customer">Balances by Customer</option>
                <option value="period">Balances by Closing Period</option>
            </select>

            <!-- Customer Balance Form -->
            <div id="customerBalanceForm" class="hidden">
                <button onclick="selectCustomerId()">Select Customer ID from Excel</button>
                <span id="selectedCustomerIdDisplay" style="margin-left:10px;color:#0078d4;"></span><br/>
                <button onclick="selectAccountLevels()">Select Account Levels</button>
                <span id="selectedAccountLevelsDisplay" style="margin-left:10px;color:#0078d4;"></span><br/>
                <button onclick="selectClosingPeriods()">Select Closing Periods</button>
                <span id="selectedClosingPeriodsDisplay" style="margin-left:10px;color:#0078d4;"></span>
            </div>

            <!-- Period Balance Form -->
            <div id="periodBalanceForm" class="hidden">
                <button onclick="selectClosingPeriod()">Select Closing Period</button>
                <span id="selectedClosingPeriodDisplay" style="margin-left:10px;color:#0078d4;"></span><br/>
                <button onclick="selectAccountLevels()">Select Account Levels</button>
                <span id="selectedAccountLevelsDisplay" style="margin-left:10px;color:#0078d4;"></span><br/>
                <button onclick="selectCustomerIds()">Select Customer IDs</button>
                <span id="selectedCustomerIdsDisplay" style="margin-left:10px;color:#0078d4;"></span>
            </div>

            <button id="submitButton" class="hidden" onclick="submitForm()">Submit</button>
        </div>
    </div>

    <script>
        Office.onReady(function(info) {
            if (info.host === Office.HostType.Excel) {
                console.log('Excel Add-in loaded successfully');
            }
        });

        function login() {
            // Implement authentication logic here
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // For POC, simple validation
            if (username && password) {
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('mainForm').classList.remove('hidden');
            }
        }

        function resetForm() {
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }

        function handleReportTypeChange() {
            const reportType = document.getElementById('reportType').value;
            const customerForm = document.getElementById('customerBalanceForm');
            const periodForm = document.getElementById('periodBalanceForm');
            const submitButton = document.getElementById('submitButton');

            customerForm.classList.add('hidden');
            periodForm.classList.add('hidden');
            
            if (reportType === 'customer') {
                customerForm.classList.remove('hidden');
                submitButton.classList.remove('hidden');
            } else if (reportType === 'period') {
                periodForm.classList.remove('hidden');
                submitButton.classList.remove('hidden');
            }
        }

        let selectedRanges = {
            customerId: null,
            accountLevels: null,
            closingPeriods: null,
            closingPeriod: null,
            customerIds: null
        };

        async function selectCustomerId() {
            try {
                await Excel.run(async (context) => {
                    const range = context.workbook.getSelectedRange();
                    range.load(["address", "values"]);
                    await context.sync();
                    if (range.values.length !== 1 || range.values[0].length !== 1) {
                        alert('Please select a single cell for Customer ID.');
                        return;
                    }
                    const value = range.values[0][0];
                    selectedRanges.customerId = {
                        address: range.address,
                        value: value
                    };
                    document.getElementById('selectedCustomerIdDisplay').textContent =
                        'Selected: ' + value + ' (Cell: ' + range.address + ')';
                    alert('Customer ID selected: ' + value + ' (Cell: ' + range.address + ')');
                });
            } catch (error) {
                console.error(error);
                alert('Error selecting Customer ID cell');
            }
        }

        async function selectAccountLevels() {
            try {
                await Excel.run(async (context) => {
                    const range = context.workbook.getSelectedRange();
                    range.load(["address", "values"]);
                    await context.sync();
                    // Flatten values array
                    const values = range.values.flat();
                    selectedRanges.accountLevels = {
                        address: range.address,
                        values: values
                    };
                    document.getElementById('selectedAccountLevelsDisplay').textContent =
                        'Selected: ' + values.join(', ') + ' (Range: ' + range.address + ')';
                    alert('Account Levels selected: ' + values.join(', ') + ' (Range: ' + range.address + ')');
                });
            } catch (error) {
                console.error(error);
                alert('Error selecting Account Levels range');
            }
        }

        async function selectClosingPeriods() {
            try {
                await Excel.run(async (context) => {
                    const range = context.workbook.getSelectedRange();
                    range.load(["address", "values"]);
                    await context.sync();
                    const values = range.values.flat();
                    selectedRanges.closingPeriods = {
                        address: range.address,
                        values: values
                    };
                    document.getElementById('selectedClosingPeriodsDisplay').textContent =
                        'Selected: ' + values.join(', ') + ' (Range: ' + range.address + ')';
                    alert('Closing Periods selected: ' + values.join(', ') + ' (Range: ' + range.address + ')');
                });
            } catch (error) {
                console.error(error);
                alert('Error selecting Closing Periods range');
            }
        }

        async function selectClosingPeriod() {
            try {
                await Excel.run(async (context) => {
                    const range = context.workbook.getSelectedRange();
                    range.load(["address", "values"]);
                    await context.sync();
                    if (range.values.length !== 1 || range.values[0].length !== 1) {
                        alert('Please select a single cell for Closing Period.');
                        return;
                    }
                    const value = range.values[0][0];
                    selectedRanges.closingPeriod = {
                        address: range.address,
                        value: value
                    };
                    document.getElementById('selectedClosingPeriodDisplay').textContent =
                        'Selected: ' + value + ' (Cell: ' + range.address + ')';
                    alert('Closing Period selected: ' + value + ' (Cell: ' + range.address + ')');
                });
            } catch (error) {
                console.error(error);
                alert('Error selecting Closing Period cell');
            }
        }

        async function selectCustomerIds() {
            try {
                await Excel.run(async (context) => {
                    const range = context.workbook.getSelectedRange();
                    range.load(["address", "values"]);
                    await context.sync();
                    const values = range.values.flat();
                    selectedRanges.customerIds = {
                        address: range.address,
                        values: values
                    };
                    document.getElementById('selectedCustomerIdsDisplay').textContent =
                        'Selected: ' + values.join(', ') + ' (Range: ' + range.address + ')';
                    alert('Customer IDs selected: ' + values.join(', ') + ' (Range: ' + range.address + ')');
                });
            } catch (error) {
                console.error(error);
                alert('Error selecting Customer IDs range');
            }
        }

        async function submitForm() {
            const reportType = document.getElementById('reportType').value;
            try {
                await Excel.run(async (context) => {
                    const sheet = context.workbook.worksheets.getActiveWorksheet();
                    if (reportType === 'customer') {
                        // Rows: Customer IDs, Columns: Account Levels
                        const customerIds = selectedRanges.customerId ? [selectedRanges.customerId.value] : [];
                        const accountLevels = selectedRanges.accountLevels ? selectedRanges.accountLevels.values : [];
                        const closingPeriods = selectedRanges.closingPeriods ? selectedRanges.closingPeriods.values : [];
                        if (customerIds.length === 0 || accountLevels.length === 0 || closingPeriods.length === 0) {
                            alert('Please select Customer ID, Account Levels, and Closing Periods.');
                            return;
                        }
                        // Table: Rows = Customer IDs, Columns = Account Levels, for each Closing Period
                        let startRow = 0;
                        let startCol = 0;
                        // Find a place to write (use Account Levels selection as anchor)
                        const anchorRange = sheet.getRange(selectedRanges.accountLevels.address);
                        anchorRange.load(["rowIndex", "columnIndex"]);
                        await context.sync();
                        startRow = anchorRange.rowIndex + accountLevels.length + 2; // leave space for headers
                        startCol = anchorRange.columnIndex;
                        // Write headers
                        sheet.getCell(startRow, startCol).values = [["Customer ID"]];
                        for (let i = 0; i < accountLevels.length; i++) {
                            sheet.getCell(startRow, startCol + 1 + i).values = [[accountLevels[i]]];
                        }
                        // Write data for each customer and closing period
                        for (let p = 0; p < closingPeriods.length; p++) {
                            const rowOffset = startRow + 1 + p * customerIds.length;
                            // Closing period label
                            sheet.getCell(rowOffset, startCol).values = [["Closing Period: " + closingPeriods[p]]];
                            for (let c = 0; c < customerIds.length; c++) {
                                const dataRow = rowOffset + 1 + c;
                                sheet.getCell(dataRow, startCol).values = [[customerIds[c]]];
                                for (let a = 0; a < accountLevels.length; a++) {
                                    // Mock balance value
                                    const balance = Math.floor(Math.random() * 10000);
                                    sheet.getCell(dataRow, startCol + 1 + a).values = [[balance]];
                                }
                            }
                        }
                    } else if (reportType === 'period') {
                        // Rows: Closing Periods, Columns: Account Levels, for each Customer ID
                        const closingPeriods = selectedRanges.closingPeriod ? [selectedRanges.closingPeriod.value] : [];
                        const accountLevels = selectedRanges.accountLevels ? selectedRanges.accountLevels.values : [];
                        const customerIds = selectedRanges.customerIds ? selectedRanges.customerIds.values : [];
                        if (closingPeriods.length === 0 || accountLevels.length === 0 || customerIds.length === 0) {
                            alert('Please select Closing Period, Account Levels, and Customer IDs.');
                            return;
                        }
                        // Table: Rows = Closing Periods, Columns = Account Levels, for each Customer ID
                        let startRow = 0;
                        let startCol = 0;
                        // Use Account Levels selection as anchor
                        const anchorRange = sheet.getRange(selectedRanges.accountLevels.address);
                        anchorRange.load(["rowIndex", "columnIndex"]);
                        await context.sync();
                        startRow = anchorRange.rowIndex + accountLevels.length + 2;
                        startCol = anchorRange.columnIndex;
                        // Write headers
                        sheet.getCell(startRow, startCol).values = [["Closing Period"]];
                        for (let i = 0; i < accountLevels.length; i++) {
                            sheet.getCell(startRow, startCol + 1 + i).values = [[accountLevels[i]]];
                        }
                        // Write data for each closing period and customer
                        for (let c = 0; c < customerIds.length; c++) {
                            const rowOffset = startRow + 1 + c * closingPeriods.length;
                            // Customer ID label
                            sheet.getCell(rowOffset, startCol).values = [["Customer ID: " + customerIds[c]]];
                            for (let p = 0; p < closingPeriods.length; p++) {
                                const dataRow = rowOffset + 1 + p;
                                sheet.getCell(dataRow, startCol).values = [[closingPeriods[p]]];
                                for (let a = 0; a < accountLevels.length; a++) {
                                    // Mock balance value
                                    const balance = Math.floor(Math.random() * 10000);
                                    sheet.getCell(dataRow, startCol + 1 + a).values = [[balance]];
                                }
                            }
                        }
                    }
                    await context.sync();
                    alert('Report generated successfully! Check your Excel worksheet.');
                });
            } catch (error) {
                console.error(error);
                alert('Error generating report: ' + error.message);
            }
        }
    </script>
</body>
</html> 
